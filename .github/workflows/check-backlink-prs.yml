name: Check Backlink PR Status

on:
  schedule:
    # Run daily at 7 AM UTC (midnight PT)
    - cron: '0 7 * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  issues: write

jobs:
  check-prs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check PR Status
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Build the report
          echo "## ðŸ” Backlink PR Status Report" > report.md
          echo "" >> report.md
          echo "**Generated:** $(date -u '+%Y-%m-%d %H:%M UTC')" >> report.md
          echo "" >> report.md
          echo "| Repository | PR | Status | Link |" >> report.md
          echo "|------------|-----|--------|------|" >> report.md

          # Track counts
          merged=0
          open=0
          closed=0

          # Define PRs to check
          declare -a prs=(
            "jamesmurdza/awesome-ai-devtools:181"
            "sourcegraph/awesome-code-ai:80"
            "mahseema/awesome-ai-tools:516"
            "eudk/awesome-ai-tools:60"
          )

          for item in "${prs[@]}"; do
            repo="${item%:*}"
            pr="${item#*:}"

            # Get PR state
            state=$(gh pr view "$pr" --repo "$repo" --json state --jq '.state' 2>/dev/null || echo "ERROR")
            url="https://github.com/$repo/pull/$pr"

            case $state in
              MERGED) emoji="âœ…"; ((merged++)) ;;
              OPEN) emoji="ðŸ“¤"; ((open++)) ;;
              CLOSED) emoji="âŒ"; ((closed++)) ;;
              *) emoji="â“" ;;
            esac

            echo "| $repo | #$pr | $emoji $state | [View]($url) |" >> report.md
          done

          echo "" >> report.md
          echo "### ðŸ“Š Summary" >> report.md
          echo "- âœ… Merged: $merged" >> report.md
          echo "- ðŸ“¤ Open: $open" >> report.md
          echo "- âŒ Closed: $closed" >> report.md

          total=$((merged + open + closed))
          if [ $total -gt 0 ]; then
            rate=$((merged * 100 / total))
            echo "- ðŸ“ˆ Acceptance Rate: $merged/$total ($rate%)" >> report.md
          fi

          cat report.md

      - name: Update GitHub Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_TITLE="ðŸ“Š Backlink PR Status (Auto-Updated)"

          # Check if issue exists
          existing=$(gh issue list --search "$ISSUE_TITLE in:title" --json number --jq '.[0].number' 2>/dev/null || echo "")

          if [ -n "$existing" ]; then
            # Update existing issue
            gh issue edit "$existing" --body-file report.md
            echo "Updated issue #$existing"
          else
            # Create new issue
            gh issue create --title "$ISSUE_TITLE" --body-file report.md --label "automated"
            echo "Created new issue"
          fi
