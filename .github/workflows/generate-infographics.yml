name: Generate Infographic Prompts

on:
  workflow_run:
    workflows: ["Fetch AI Tool Releases"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      tool:
        description: 'Tool ID to generate infographic for'
        required: false
        type: choice
        options:
          - all
          - claude-code
          - kiro
          - openai-codex
          - gemini-cli
          - cursor
          - github-copilot
          - windsurf
      generate_images:
        description: 'Generate images using Nano Banana Pro'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  issues: write

concurrency:
  group: push-to-main
  cancel-in-progress: false

jobs:
  generate-prompts:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main  # Always get latest to include newly fetched releases
          fetch-depth: 0

      - name: Download old releases artifact (for notification comparison)
        if: github.event_name == 'workflow_run'
        uses: actions/download-artifact@v4
        with:
          name: old-releases-for-notification
          path: /tmp
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
        continue-on-error: true  # May not exist if no new releases

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        run: corepack enable pnpm

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate infographic prompts
        id: generate
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          mkdir -p generated-prompts

          TOOL="${{ github.event.inputs.tool || 'all' }}"
          GENERATE_IMAGES="${{ github.event.inputs.generate_images }}"
          IS_WORKFLOW_RUN="${{ github.event_name == 'workflow_run' }}"

          # Build extra flags
          # Always generate images when triggered by workflow_run (nightly), or when manually requested
          EXTRA_FLAGS="--all-formats"
          if [ "$GENERATE_IMAGES" = "true" ] || [ "$IS_WORKFLOW_RUN" = "true" ]; then
            EXTRA_FLAGS="$EXTRA_FLAGS --generate-image --update-releases"
          fi

          # Track failures for issue creation
          FAILURES=""

          if [ "$TOOL" = "all" ]; then
            # Generate for ALL releases missing infographics (from last 7 days)
            echo "Generating infographics for all recent releases missing them..."
            if ! node scripts/generate-infographic-prompt.mjs --all-missing $EXTRA_FLAGS; then
              FAILURES="all-missing"
            fi
          else
            echo "Generating prompt for $TOOL..."
            if ! node scripts/generate-infographic-prompt.mjs --tool=$TOOL $EXTRA_FLAGS; then
              FAILURES="$TOOL"
            fi
          fi

          # Check for any failure reports created
          FAILURE_COUNT=$(ls -1 generated-prompts/failure-*.json 2>/dev/null | wc -l || echo "0")
          echo "failure_count=$FAILURE_COUNT" >> $GITHUB_OUTPUT

          if [ "$FAILURE_COUNT" -gt 0 ]; then
            echo "has_failures=true" >> $GITHUB_OUTPUT
          else
            echo "has_failures=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for infographic changes
        id: infographic-changes
        run: |
          if [ -d "public/images/infographics" ] && [ -n "$(ls -A public/images/infographics 2>/dev/null)" ]; then
            echo "has_infographics=true" >> $GITHUB_OUTPUT
          else
            echo "has_infographics=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit infographics and releases.json updates
        if: steps.infographic-changes.outputs.has_infographics == 'true'
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          git add public/images/infographics/ public/data/releases.json
          git diff --staged --quiet || git commit -m "chore: add generated infographics for releases"
          git pull --rebase origin main
          git push

      - name: Notify subscribers about new releases (with infographics)
        if: github.event_name == 'workflow_run' && steps.infographic-changes.outputs.has_infographics == 'true'
        env:
          NOTIFY_API_KEY: ${{ secrets.NOTIFY_API_KEY }}
          NOTIFY_API_URL: https://havoptic.com/api/notify
        run: |
          # Only notify if we have the old releases artifact
          if [ -f /tmp/old-releases.json ]; then
            echo "Sending notifications with infographics included..."
            node scripts/notify-subscribers.mjs --old=/tmp/old-releases.json --new=public/data/releases.json
          else
            echo "No old releases artifact found, skipping notification"
          fi

      - name: Create GitHub issues for failures
        if: steps.generate.outputs.has_failures == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for FAILURE_FILE in generated-prompts/failure-*.json; do
            if [ -f "$FAILURE_FILE" ]; then
              TOOL=$(jq -r '.tool' "$FAILURE_FILE")
              VERSION=$(jq -r '.version' "$FAILURE_FILE")
              REASON=$(jq -r '.reason' "$FAILURE_FILE")
              TIMESTAMP=$(jq -r '.timestamp' "$FAILURE_FILE")
              SOURCE_URL=$(jq -r '.sourceUrl // "N/A"' "$FAILURE_FILE")
              CONTENT_LENGTH=$(jq -r '.fetchedContentLength // 0' "$FAILURE_FILE")
              RETRY_ATTEMPTS=$(jq -r '.retryAttempts // 0' "$FAILURE_FILE")

              # Check if issue already exists for this tool/version
              EXISTING=$(gh issue list --label "auto-remediation" --search "$TOOL $VERSION in:title" --json number -q 'length')
              if [ "$EXISTING" -gt 0 ]; then
                echo "Issue already exists for $TOOL $VERSION, skipping..."
                continue
              fi

              echo "Creating issue for $TOOL $VERSION..."
              gh issue create \
                --title "ðŸ”´ Infographic generation failed: $TOOL $VERSION" \
                --label "bug,auto-remediation" \
                --body "$(cat <<EOF
          ## Failure Details
          - **Tool:** $TOOL
          - **Version:** $VERSION
          - **Timestamp:** $TIMESTAMP
          - **Reason:** $REASON
          - **Source URL:** $SOURCE_URL
          - **Content Length:** $CONTENT_LENGTH chars
          - **Retry Attempts:** $RETRY_ATTEMPTS
          - **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ## Full Context
          \`\`\`json
          $(cat "$FAILURE_FILE")
          \`\`\`

          ## Next Steps
          This issue will trigger the auto-remediation workflow to investigate and attempt a fix.

          If auto-remediation fails after 2 attempts, manual investigation will be required.
          EOF
          )"
            fi
          done

      - name: Upload prompts as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: infographic-prompts-${{ github.run_id }}
          path: generated-prompts/
          retention-days: 30
