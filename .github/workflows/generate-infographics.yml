name: Generate Infographic Prompts

on:
  workflow_run:
    workflows: ["Fetch AI Tool Releases"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      tool:
        description: 'Tool ID to generate infographic for'
        required: false
        type: choice
        options:
          - all
          - claude-code
          - kiro
          - openai-codex
          - gemini-cli
          - cursor
          - aider
      generate_images:
        description: 'Generate images using Nano Banana Pro'
        required: false
        type: boolean
        default: false

jobs:
  generate-prompts:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main  # Always get latest to include newly fetched releases

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate infographic prompts
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          mkdir -p generated-prompts

          TOOL="${{ github.event.inputs.tool || 'all' }}"
          GENERATE_IMAGES="${{ github.event.inputs.generate_images }}"

          # Build extra flags
          EXTRA_FLAGS="--all-formats"
          if [ "$GENERATE_IMAGES" = "true" ]; then
            EXTRA_FLAGS="$EXTRA_FLAGS --generate-image --update-releases"
          fi

          if [ "$TOOL" = "all" ]; then
            # Generate for all tools with releases
            for tool in claude-code kiro openai-codex gemini-cli cursor aider; do
              echo "Generating prompt for $tool..."
              node scripts/generate-infographic-prompt.mjs --tool=$tool $EXTRA_FLAGS || echo "Skipping $tool (no releases found)"
            done
          else
            echo "Generating prompt for $TOOL..."
            node scripts/generate-infographic-prompt.mjs --tool=$TOOL $EXTRA_FLAGS
          fi

      - name: Check for infographic changes
        id: infographic-changes
        run: |
          if [ -d "public/images/infographics" ] && [ -n "$(ls -A public/images/infographics 2>/dev/null)" ]; then
            echo "has_infographics=true" >> $GITHUB_OUTPUT
          else
            echo "has_infographics=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit infographics and releases.json updates
        if: steps.infographic-changes.outputs.has_infographics == 'true'
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          git add public/images/infographics/ public/data/releases.json
          git diff --staged --quiet || git commit -m "chore: add generated infographics for releases"
          git push

      - name: Upload prompts as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: infographic-prompts-${{ github.run_id }}
          path: generated-prompts/
          retention-days: 30
