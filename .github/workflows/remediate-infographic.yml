name: Remediate Infographic Failure

on:
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  issues: write

concurrency:
  group: push-to-main
  cancel-in-progress: false

jobs:
  remediate:
    # Only run for issues with the auto-remediation label
    if: contains(github.event.issue.labels.*.name, 'auto-remediation')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Check circuit breaker
        id: circuit-breaker
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TODAY=$(date +%Y-%m-%d)
          FAILURES_TODAY=$(gh issue list --label "auto-remediation" \
            --search "created:$TODAY" --json number -q 'length')

          echo "Failures today: $FAILURES_TODAY"

          if [ "$FAILURES_TODAY" -gt 5 ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            gh issue comment ${{ github.event.issue.number }} \
              --body "⚠️ **Circuit breaker triggered:** More than 5 auto-remediation issues created today. Skipping automatic remediation to prevent excessive API costs. Manual investigation required."
            gh issue edit ${{ github.event.issue.number }} --add-label "needs-manual-review"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Check attempt count
        id: attempts
        if: steps.circuit-breaker.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Count existing "attempt-X" labels
          LABELS=$(gh issue view ${{ github.event.issue.number }} --json labels -q '.labels[].name')
          ATTEMPT_COUNT=$(echo "$LABELS" | grep -c "^attempt-" || echo "0")
          NEXT_ATTEMPT=$((ATTEMPT_COUNT + 1))
          MAX_ATTEMPTS=2

          echo "Current attempts: $ATTEMPT_COUNT, Next: $NEXT_ATTEMPT, Max: $MAX_ATTEMPTS"

          if [ $NEXT_ATTEMPT -gt $MAX_ATTEMPTS ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            gh issue comment ${{ github.event.issue.number }} \
              --body "⚠️ **Max remediation attempts reached ($MAX_ATTEMPTS).** Automatic remediation has been exhausted. Manual investigation is required.

          ### What was tried:
          - Attempted to fetch release notes from alternative sources
          - Tried different extraction strategies
          - Validated content availability

          ### Suggested manual actions:
          1. Check if the release URL is accessible
          2. Verify the release has meaningful content
          3. Consider if this release needs an infographic (single-line bugfixes may not)
          4. Manually add content to \`fullNotes\` in releases.json if needed"
            gh issue edit ${{ github.event.issue.number }} --add-label "needs-manual-review"
            gh issue edit ${{ github.event.issue.number }} --remove-label "auto-remediation"
            exit 0
          fi

          gh issue edit ${{ github.event.issue.number }} --add-label "attempt-$NEXT_ATTEMPT"
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "attempt=$NEXT_ATTEMPT" >> $GITHUB_OUTPUT

      - name: Extract failure context from issue
        id: context
        if: steps.circuit-breaker.outputs.skip != 'true' && steps.attempts.outputs.skip != 'true'
        run: |
          # Extract tool and version from issue body
          BODY='${{ github.event.issue.body }}'

          # Use grep with Perl regex for portable extraction
          TOOL=$(echo "$BODY" | grep -oP '\*\*Tool:\*\* \K[^\n*]+' | head -1 | tr -d ' ')
          VERSION=$(echo "$BODY" | grep -oP '\*\*Version:\*\* \K[^\n*]+' | head -1 | tr -d ' ')
          SOURCE_URL=$(echo "$BODY" | grep -oP '\*\*Source URL:\*\* \K[^\n*]+' | head -1 | tr -d ' ')

          echo "Extracted - Tool: $TOOL, Version: $VERSION, URL: $SOURCE_URL"

          echo "tool=$TOOL" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "source_url=$SOURCE_URL" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        if: steps.circuit-breaker.outputs.skip != 'true' && steps.attempts.outputs.skip != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        if: steps.circuit-breaker.outputs.skip != 'true' && steps.attempts.outputs.skip != 'true'
        run: corepack enable pnpm

      - name: Install dependencies
        if: steps.circuit-breaker.outputs.skip != 'true' && steps.attempts.outputs.skip != 'true'
        run: pnpm install --frozen-lockfile

      - name: Run remediation script
        id: remediate
        if: steps.circuit-breaker.outputs.skip != 'true' && steps.attempts.outputs.skip != 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          node scripts/remediate-infographic.mjs \
            --tool=${{ steps.context.outputs.tool }} \
            --version=${{ steps.context.outputs.version }} \
            --issue=${{ github.event.issue.number }} \
            --attempt=${{ steps.attempts.outputs.attempt }} || true

          # Check if remediation succeeded
          if [ -f "remediation-result.json" ]; then
            STATUS=$(jq -r '.status' remediation-result.json)
            echo "status=$STATUS" >> $GITHUB_OUTPUT
          else
            echo "status=error" >> $GITHUB_OUTPUT
          fi

      - name: Update issue with results
        if: steps.circuit-breaker.outputs.skip != 'true' && steps.attempts.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f "remediation-result.json" ]; then
            STATUS=$(jq -r '.status' remediation-result.json)
            ANALYSIS=$(jq -r '.analysis // "No analysis available"' remediation-result.json)
            ACTIONS=$(jq -r '.actions // "No actions taken"' remediation-result.json)
            API_CALLS=$(jq -r '.apiCallsUsed // 0' remediation-result.json)

            gh issue comment ${{ github.event.issue.number }} \
              --body "## Auto-Remediation Results (Attempt ${{ steps.attempts.outputs.attempt }})

          **Status:** $STATUS
          **API Calls Used:** $API_CALLS/3

          ### Analysis
          $ANALYSIS

          ### Actions Taken
          $ACTIONS

          ---
          *Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}*"

            if [ "$STATUS" = "fixed" ]; then
              gh issue close ${{ github.event.issue.number }} \
                --comment "✅ Issue resolved by auto-remediation. The infographic has been regenerated successfully."
            fi
          else
            gh issue comment ${{ github.event.issue.number }} \
              --body "## Auto-Remediation Error (Attempt ${{ steps.attempts.outputs.attempt }})

          The remediation script encountered an error and could not complete.

          Check the workflow logs for details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi

      - name: Commit any fixes
        if: steps.remediate.outputs.status == 'fixed'
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

          # Check for changes to commit
          if [ -n "$(git status --porcelain public/)" ]; then
            git add public/images/infographics/ public/data/releases.json
            git commit -m "fix: regenerate infographic for ${{ steps.context.outputs.tool }} ${{ steps.context.outputs.version }}

          Auto-remediation for issue #${{ github.event.issue.number }}"
            git pull --rebase origin main
            git push
          fi
